# 纳伏电压表
低噪声纳伏表设计文件与代码

该设计包含五块电路板:
1. 纳伏表主板
2. 一块开关电源子板(SMPS)，用于将电池电压降压至设计中使用的多种电源轨电压
3. 一块配备电池管理系统(BMS)的电池板，适用于4串21700电池组
4. 一块带电池充电器的后面板电路板
5. 一块前面板

此代码库还将包含STM32U575微控制器的源该控制器用于连接各类外围设备。

![ADR1399-boardfront](https://github.com/curtisseizert/Nanovoltmeter/assets/22351001/9ea7e242-64c5-4fc7-a24f-2e9ce9876d46)
![ADR1399-boardrear](https://github.com/curtisseizert/Nanovoltmeter/assets/22351001/88aedb9b-be14-4447-87e4-bf99c72b94a3)

注意: 当前版本的电路板未经修改无法正常工作，但原理图中已添加注释说明所需修改。本项目仍应视为处于开发阶段，但此处提供了完整的设计资料，以供从事低噪声、高分辨率电压传感项目的研究者参考使用。

当前状态
-------------
由于我当前正在完成另一项目，电路板的C修订版正处于间歇性开发阶段。新版设计将着力提升系统的稳健性，重点解决以下问题：对共模噪声的明显敏感性、电源保护不足导致特定故障时的级联失效，以及与电池放电相关的轻微漂移现象。我正在研究改进从ADC转换中获取SPI数据的方法，旨在实现AD4030-24芯片的最大采样率(2 MSPS)，以降低噪声并减少混叠可能性。本次修订还包括对关键前端放大器的微调设计，以提升增益和稳定性。此外，新版将取消ADR1399基准电压源选项。

固件2.0版本优化了数据处理与用户输入的交互逻辑，并通过增强DMA利用率降低了CPU负载。单元测试正在进行中，部分功能尚未完全实现，但即将陆续发布。该版本采用类SCPI语法构建命令体系，虽未完全遵循SCPI规范，但升级后的固件将更有利于开展系统性能测试工作。

我已制作了两块此类电路板：一块采用LTC6655基准源，另一块采用ADR1399基准源。针对ADR1399版本，我通过内部短路和外部1 mV基准信号对其噪声与偏移性能进行了测试。为使两块电路板正常工作均需进行若干修改，我已在C修订版原理图中进行了相应调整(但尚未完成版图设计)。在内部短路测试条件下，采用LTC6655基准源的电路板展现出更优异的噪声性能与温度稳定性。

设计背景
-----------------

此前已构建的输入级概念验证模型显示，其噪声谱密度(NSD)在约1.2 nV/$\sqrt{Hz}$水平保持平坦。在每秒1次采样的条件下，峰峰值噪声约为 15nV。该仪表的温度系数约为1 nV/K，但对温度波动的敏感性较为明显，且电池放电过程中功耗变化导致约 1nV/小时的漂移。此原型机还因输入调制器开关的电荷注入效应存在约 3nA 的偏置电流。本修订版本拟针对这些问题进行如下改进：

1. 电路板的主要电源轨采用低噪声降压转换器(LT8608S)与Cuk转换器，并集成在带屏蔽的子板上，以确保板载低压差LDOs在电池放电全程保持稳定的压降裕量
2. 优化布局设计降低了对温度变化的敏感性。输入级被置于屏蔽外壳内，周围环绕隔离槽。此外，主要的功率耗散元件被安置在屏蔽罩外侧的对向位置。
3. 输入开关现采用低电容四路MOSFET阵列(PE4140)，其栅极驱动电压由四通道DAC独立产生。模型实验已证明，通过调节DAC开关电平与死区时间，将偏置电流降至<5pA具有可行性，但该方面仍需进一步优化。
4. 现采用高速精密ADC(AD4030-24)检测开关周期间的偏移误差，通过16位DAC调制输入JFET的沟道电流，从而控制输入差分放大器的偏移电压。根据原理图设计，该DAC的微调范围约为+/-625μV(最小分辨率LSB=20nV)。微调差分放大器的低增益特性，使得其在输入极限条件下的跨导变化率＜1%。这种设计可在仪器预热阶段测量微调增益，实现控制回路的单周期稳定。
5. 控制回路的数字化实现还允许关闭自动调零功能，或以极低频率运行输入开关，从而最大程度减少电荷注入效应。

其他功能包括:
1. 提供两种电压基准的封装选项: 采用ADR1399可实现最低噪声/最高稳定性，选用LTC6655则能降低功耗
2. 一个光耦隔离的外部触发输入接口，例如可用于将时钟同步至市电周期。
3. 输入保护功能在差分电压达2V时启动限流(典型值10mA，最大值15mA)，可防止端子意外接入100V电压时受损。电路同时配备气体放电管(GDT)，为更高电压的瞬态冲击提供防护。
4. 两个输入量程：±2 mV 与 ±20 mV。
5. (采用LTC6655时)功耗降低

工作原理
----------------------

<img width="1753" alt="SimplifiedSchematic" src="https://github.com/curtisseizert/Nanovoltmeter/assets/22351001/f38c8695-773f-48de-b3a6-2627330c2b3a">

输入调制器(SW1)交替切换输入信号与反馈信号，将其连接至高增益、低噪声分立式JFET差分放大器的输入端。差分放大器的输出端通过同步解调器(SW2)连接至运算放大器(U10)的输入端口，前端输出信号即取自该运放。ADC读取调制器每个相位对应的输出电压。若两相位读数差值超过死区阈值，控制器将相应增减Vos DAC(U44)的数值，通过调节输入差分放大器的沟道电流来抵消差分放大器的偏移。沟道电流由U20构成的低增益跨导级控制。为消除ADC及相关信号调理电路的偏移电压与1/f噪声，在ADC驱动器输入端设置切换开关，将该模块的输入信号反向连接，使得调制器/解调器的工作频率成为ADC输入开关频率的整数倍。

该拓扑结构可将输入级的失调电压(及1/f噪声)调制到开关频率，而输入信号本身不被调制。通过失调归零反馈回路，这个经调制的误差信号被大幅抑制，从而显著降低斩波频率处的噪声功率，并采用用户可选阶数(1至3阶)的级联积分梳状(sinc)滤波器进行滤波。由于输入级JFET的输入电容较大(约75pF)，差分放大器失调归零的同时也降低了斩波频率下的电流脉冲干扰。

因此，理论上唯一存在的失调、漂移或1/f噪声源来自连接解调后差分放大器输出的运算放大器，而所有这些误差源都会受到差分放大器增益(约3500倍)的衰减。输入级JFET采用类Sziklai拓扑与PNP型双极晶体管Q16、Q21配对，以提升输入放大器的跨导，使其能在高增益下工作。漏极电阻R91和R100的取值是噪声、增益与稳定性之间的折衷：在133Ω阻值下，每个JFET的漏极电流约为1mA，双极晶体管的集电极电流也各约1mA。更大的电阻值会略微增加噪声、提高增益，并因环路增益增大而降低复合放大器的相位裕度。设计中采用的运算放大器(ADA4625-1)是一款高精度、低噪声器件，其失调和漂移极低，当被3500倍衰减后这些误差源可忽略不计。按典型规格书数值计算，该运放约带来4nV失调电压、0.06nV/K温度系数，其1/f噪声拐点频率约为0.1MHz。实际应用中，寄生效应(特别是热电动势)被证实是更大的误差源，前面板处未校正的失调电压约为250nV，1/f拐点频率略低于1MHz(取决于环境温度稳定性)。测量(内部)短路输入时的噪声谱密度＜1.2nV/√Hz，在10秒采样周期下，我观测到10000秒内的峰峰值噪声仅为1.36nV。

<img width="3249" height="2311" alt="ShortNoise_LTC6655_sinc2" src="https://github.com/user-attachments/assets/e446475a-df6a-4a1f-96a1-a6e8d4d18aea" />

观测记录
------------

调制器频率在600-2000Hz范围内较为理想，系统默认设定为1800Hz。在失调校正环路中设置死区是必要的，可防止模拟输出频谱中出现伪影。关键问题在于对低频噪声源(可能来自开关电源(SMPS)，也可能包括60Hz工频干扰）较为敏感。调制频率最高可提升至14.4kHz，但随之而来的前端稳定时间与ADC信号调理电路时耗会占据更大比例的潜在转换时间，从而导致噪声增加。

<img width="3277" height="2311" alt="NVM B no deadband, 1 LSB inc, offsets" src="https://github.com/user-attachments/assets/7f692774-247d-44a0-b52e-0cfccc16df01" />
无死区时的噪声谱密度图，显示V_os校正环路引起的混叠现象

该仪器实用性的最大限制在于：当有设备连接前面板时，噪声会显著增加且偏移电压发生变化。无论输入继电器是否处于内部短路测量状态，该效应都会出现。最可能的原因是：通过USB电缆屏蔽层接保护地的仪器外壳，其电位相对于电路地发生了浮动，并通过容性耦合影响了某些敏感部分。然而，若通过隔离器连接USB电缆(此时屏蔽层与保护地断开)，噪声状况反而会恶化而非改善。

采用Sinc2滤波器有效改善了频谱中极低频段(<10MHz)存在的明显混叠伪影。而使用Sinc3滤波器并未带来显著改进。在环境条件足够稳定的情况下，噪声频谱平坦度(内部短路时)可重复延伸至1MHz以下。

<img width="3249" height="2311" alt="ShortNoise_LTC6655_sinc1" src="https://github.com/user-attachments/assets/1055977f-d3ce-460c-9226-e360cdb6e724" />
<img width="3249" height="2311" alt="ShortNoise_LTC6655_sinc2" src="https://github.com/user-attachments/assets/e779fb28-2be0-43f0-8d62-cbfe5655bbc9" />

尽管该纳伏表具有小于1nV/K的失调温度系数，但其对温度变化速率仍表现出一定敏感性(即失调电压与温度对时间的二阶导数相关)。这种现象是合理的，因为温度变化速率会改变电路板上的温度梯度分布，进而影响输入端的寄生热电偶效应。此外，电源在较低输入电压下效率略高，导致电池放电时散热减少，这也对失调电压产生影响。在长时间采集过程中(如下方展示的LTC6655基准源示例)，这会引起小于0.1nV/小时的漂移。值得注意的是，在输入温度波动约2.5K的100小时采集周期内，整体漂移仅约8 nV。

<img width="3540" height="2340" alt="LongCapture_LTC6655_0p01SPS_sinc2" src="https://github.com/user-attachments/assets/bc8703da-5e35-4ad9-97cf-4228a2d44c8a" />
<img width="3540" height="2340" alt="LongCapture_ADR1399_0p01SPS" src="https://github.com/user-attachments/assets/30137af6-4506-4fc8-9191-a88c3c338448" />

放大器的线性度预期会相当出色，因为失调校正回路能使前端放大器的输入端电压保持一致，与输入信号无关。非线性的主要来源应为增益设定电阻——功耗增加导致的温度变化可能改变电阻比例及前端增益。为测试放大器线性度，我采用基于LTZ1000A和DAC11001B构建的高精度源(经测试线性误差小于2ppm)，并配合200K/20R分压器将输出电压范围降至0至1mV。通过对该范围内多次11点扫频测量结果取平均，得到最大线性误差为1.5ppm。由于外接设备接入前面板时会引入额外噪声，取平均处理是必要的。较低增益的±20mV量程对外部噪声源更敏感(可能源于放大器在低增益下稳定性降低)，导致该量程的线性度误差评估不具备实际可行性。在所有外部信号源测量中，我发现将测试引线绕在纳米晶磁环上可显著降低噪声，此为最优处理方案。

<img width="2680" height="1569" alt="LinearitySweep" src="https://github.com/user-attachments/assets/795f5279-375e-4419-a274-6ec6c7499851" />

外部测量时的性能下降
-------------------------------------------------

综合来看，我在外部信号源测量中遇到的难题错综复杂，可能同时涉及多个问题。现将观察现象汇总于此，试图剖析其成因并探索潜在解决方案：
1. 40dB增益档位比60dB增益档位更敏感。较低增益档位虽相位裕度较小，但在较高频率处仍保持60dB增益，这是确保放大器在低增益下稳定工作的必要设计。这表明存在稳定性相关问题，例如当放大器接入感性源阻抗时，相位裕度会下降(导致开关事件后出现振铃等现象)。对于此类采用多JFET并联(其栅源电容较大)的放大器，感性信号源会带来显著挑战，因其可能在与感性输入结合时产生谐振增益。
2. 在输入端使用共模扼流圈能改善性能，这暗示了远高于放大器通带的频率所产生的影响。该共模扼流圈的电感量约为800μH，其在60Hz频率下呈现的阻抗可忽略不计。
3. 我通过外接台式电源为仪器供电以消除开关电源信号，并记录了模拟输出端的频谱。在前端增益设为60dB且断开10nF输入电容的情况下，外部短路时斩波频率谐波处的峰值为内部短路时的20dB高。这可能是输入端电感效应所致，因为内部与外部短路之间的输入保护电路中串有磁珠。此类伪影可能导致混叠现象。
内部短路模拟输出，增益=1000
<img width="1920" height="1027" alt="NVM B Internal short Gain1000 Linear supply CapOff" src="https://github.com/user-attachments/assets/c67c16a7-33d1-4317-96ab-d731726bbf0c" />
外部短路模拟输出，增益=1000<img width="1920" height="1027" alt="NVM B External short Gain1000 Linear supply CapOff" src="https://github.com/user-attachments/assets/356a7ddc-46ca-4e82-b0e1-3d37ad8144b1" />
4. 将信号源接入输入端会导致内部短路的偏移量发生变化(约200 nV)。该现象的成因尚不明确。线性度测试部分提到的信号源实际上内置了100:1衰减器用于低电压测量，但若将其直接接入纳伏表，噪声会大幅增加，导致ppm级偏移测量无法实现。输入接口采用LEMO-0S-304型连接器，其外壳与仪器机箱电气连接，而机箱又通过USB电缆接保护地。总体而言，屏蔽层两端都接地的电缆性能显著差于单端悬空屏蔽的电缆，这表明尽管两个机箱地与电路地隔离，但其相互连接仍存在问题。在该场景下，必须使用尼龙螺钉将USB接口固定于信号源后面板(从而断开与保护地的连接)才能获得可靠测量结果。输入端的敏感电路大多通过板级射频屏蔽层获得了良好的静电屏蔽保护，但输入保护电路、开关继电器、斩波解调器及运算放大器均处于这些屏蔽层之外。即使不构成接地回路(例如仅将未连接的电缆插入前面板时)也能观测到此现象，因此需要更多测试来确定引发该偏移的最小条件配置(例如：仅连接外壳是否会出现该现象？还是必须同时连接实际输入引线(与电路板连通)？若需通过额外屏蔽来抑制此效应，可能难以维持现有外形尺寸。